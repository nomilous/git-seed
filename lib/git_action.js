// Generated by CoffeeScript 1.4.0
var GitAction, GitSeed, fs, task;

GitSeed = require('nezkit').seed;

fs = require('fs');

task = require('when').defer;

module.exports = GitAction = {
  gotDirectory: function(directory) {
    try {
      return fs.lstatSync(directory).isDirectory();
    } catch (error) {
      return false;
    }
  },
  isError: function() {
    return error === '';
  },
  showError: function() {
    return console.log(GitAction.error);
  },
  error: 'unknown or missing command',
  configure: function(program, onSuccess, onError, onNotify) {
    var plugin;
    if (typeof onSuccess === 'undefined' || typeof onError === 'undefined') {
      throw new Error('requires promise handlers');
    }
    GitAction.task = task();
    GitAction.task.notify = onNotify;
    GitAction.task.promise.then(onSuccess, onError, onNotify);
    GitAction.root = '.';
    GitAction.message = program.message;
    plugin = program.packageManager || 'npm';
    try {
      GitAction.plugin = require("git-seed-" + plugin);
    } catch (error) {
      onNotify.info.bad('missing plugin', error.toString());
      process.exit(1);
    }
    return GitAction;
  },
  init: function() {
    if (typeof GitAction.task === 'undefined') {
      throw new Error('configure() was not called');
    }
    GitAction.task.notify.info.normal('start seed init', "recurse for git repositories in '" + GitAction.root + "'");
    GitAction.error = '';
    if (!GitAction.gotDirectory(GitAction.root + '/.git')) {
      GitAction.task.notify.info.bad('missing root repo', "no git reposititory in '" + GitAction.root + "'");
      return;
    }
    return GitSeed.init(GitAction.task, GitAction.root, GitAction.plugin);
  },
  status: function() {
    if (typeof GitAction.task === 'undefined') {
      throw new Error('configure() was not called');
    }
    GitAction.task.notify.info.normal('start seed status', "for all git repositories in '" + GitAction.root + "/.git-seed'");
    GitAction.error = '';
    return (new GitSeed(GitAction.task, GitAction.root, GitAction.plugin)).status();
  },
  clone: function() {
    if (typeof GitAction.task === 'undefined') {
      throw new Error('configure() was not called');
    }
    GitAction.task.notify.info.normal('start seed clone', "for all git repositories in '" + GitAction.root + "/.git-seed'");
    GitAction.error = '';
    return (new GitSeed(GitAction.task, GitAction.root, GitAction.plugin)).clone();
  },
  commit: function() {
    if (typeof GitAction.task === 'undefined') {
      throw new Error('configure() was not called');
    }
    GitAction.task.notify.info.normal('start seed commit', "for any git repositories with staged changes in '" + GitAction.root + "/.git-seed' ");
    GitAction.error = '';
    if (!GitAction.message) {
      GitAction.task.notify.info.bad('missing commit message', 'use -m "message"');
      return;
    }
    return (new GitSeed(GitAction.task, GitAction.root, GitAction.plugin)).commit(GitAction.message);
  },
  pull: function() {
    if (typeof GitAction.task === 'undefined') {
      throw new Error('configure() was not called');
    }
    GitAction.task.notify.info.normal('start seed pull', "for all git repositories in '" + GitAction.root + "/.git-seed'");
    GitAction.error = '';
    return (new GitSeed(GitAction.task, GitAction.root, GitAction.plugin)).pull(true, function(error, result) {
      if (error == null) {
        return (new GitSeed(GitAction.task, GitAction.root, GitAction.plugin)).pull(false);
      }
    });
  }
};
